<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>지렁이게임 (Snake)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap (CDN) -->
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <style>
        /* 캔버스가 CSS로 리사이즈되더라도 선명한 느낌을 위해 여백을 살짝 둠 */
        canvas { display:block; background:#121416; }
        canvas:focus { outline: none; }
        canvas { cursor: crosshair; }
    </style>
</head>
<body>
<div class="container py-3">
    <div class="row g-3">
        <!-- 게임 보드 -->
        <div class="col-lg-8">
            <!-- 내부 해상도는 고정(480x480), CSS로는 가로폭에 맞춰 자동 확장 -->
            <canvas id="game" width="480" height="480" class="border rounded w-100" aria-label="지렁이 게임 보드" tabindex="0"></canvas>

            <div class="d-flex justify-content-between mt-2">
                <div>점수: <span id="score">0</span></div>
                <div>레벨: <span id="level">1</span></div>
                <div>상태: <span id="status" class="text-secondary">대기</span></div>
            </div>
            <p class="small text-muted mt-2 mb-0">조작: 방향키 이동 · Space 시작/일시정지 · R 다시 시작</p>
        </div>

        <!-- 시작/옵션 패널 -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header fw-semibold">지렁이게임 시작 메뉴</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label for="speed" class="form-label">속도</label>
                        <select id="speed" class="form-select form-select-sm">
                            <option value="160">느림</option>
                            <option value="120" selected>보통</option>
                            <option value="80">빠름</option>
                            <option value="50">광속</option>
                        </select>
                    </div>

                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="wrap">
                        <label class="form-check-label" for="wrap">벽 통과(반대편으로 이동)</label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="speedUp" checked>
                        <label class="form-check-label" for="speedUp">먹을 때 가속</label>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success" id="btnStart">시작/일시정지 (Space)</button>
                        <button class="btn btn-secondary" id="btnReset">다시 시작 (R)</button>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body small text-muted">
                    팁: iframe에 넣을 때 키보드 조작이 안 먹으면, 캔버스를 한 번 클릭해 포커스를 주세요.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ====== 기본 설정 ======
    const CELL = 24;               // 셀 크기(px)
    const COLS = 20, ROWS = 20;    // 20x20 그리드 => 480x480
    const START_LEN = 3;
    const SCORE_PER_APPLE = 10;
    const MIN_INTERVAL = 30;

    // ====== 요소 참조 ======
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const scoreEl = document.getElementById('score');
    const levelEl = document.getElementById('level');
    const statusEl = document.getElementById('status');

    const speedSel = document.getElementById('speed');
    const wrapChk = document.getElementById('wrap');
    const speedUpChk = document.getElementById('speedUp');
    const btnStart = document.getElementById('btnStart');
    const btnReset = document.getElementById('btnReset');

    // ====== 상태 ======
    let snake, dir, nextDir, food, interval, loopId, running, level, score;

    function initGame() {
        // 초기 지렁이 위치: 화면 중앙에서 오른쪽으로 진행
        snake = [];
        for (let i = 0; i < START_LEN; i++) {
            snake.push({ x: Math.floor(COLS / 2) - i, y: Math.floor(ROWS / 2) });
        }
        dir = { x: 1, y: 0 };
        nextDir = { x: 1, y: 0 };
        placeFood();
        score = 0;
        level = 1;
        interval = parseInt(speedSel.value, 10);
        updateHud();
        draw();
        setStatus('대기');
    }

    function setStatus(text) { statusEl.textContent = text; }
    function updateHud() { scoreEl.textContent = score; levelEl.textContent = level; }

    function placeFood() {
        while (true) {
            const fx = Math.floor(Math.random() * COLS);
            const fy = Math.floor(Math.random() * ROWS);
            if (!snake.some(s => s.x === fx && s.y === fy)) {
                food = { x: fx, y: fy };
                return;
            }
        }
    }

    function startLoop() {
        if (loopId) clearInterval(loopId);
        loopId = setInterval(tick, interval);
        running = true;
        setStatus('플레이 중');
    }

    function stopLoop() {
        if (loopId) clearInterval(loopId);
        loopId = null;
        running = false;
        setStatus('일시정지');
    }

    function resetGame() {
        stopLoop();
        initGame();
    }

    function tick() {
        // 반대 방향 즉시 전환 금지
        if ((nextDir.x !== -dir.x) || (nextDir.y !== -dir.y)) {
            dir = nextDir;
        }

        const head = { ...snake[0] };
        head.x += dir.x;
        head.y += dir.y;

        // 벽 처리
        if (wrapChk.checked) {
            if (head.x < 0) head.x = COLS - 1;
            if (head.x >= COLS) head.x = 0;
            if (head.y < 0) head.y = ROWS - 1;
            if (head.y >= ROWS) head.y = 0;
        } else {
            if (head.x < 0 || head.x >= COLS || head.y < 0 || head.y >= ROWS) {
                return gameOver();
            }
        }

        // 몸 충돌
        if (snake.some(seg => seg.x === head.x && seg.y === head.y)) {
            return gameOver();
        }

        // 이동
        snake.unshift(head);

        // 먹이 확인
        if (head.x === food.x && head.y === food.y) {
            score += SCORE_PER_APPLE;
            // 속도 점진 가속
            if (speedUpChk.checked) {
                interval = Math.max(MIN_INTERVAL, Math.floor(interval * 0.95));
                level++;
                if (running) startLoop(); // 가속 반영
            }
            updateHud();
            placeFood();
        } else {
            snake.pop(); // 성장 없으면 꼬리 제거
        }

        draw();
    }

    function gameOver() {
        stopLoop();
        setStatus('게임오버');
        drawOverlay('GAME OVER', '#dc3545');
    }

    // ====== 그리기 ======
    function draw() {
        // 배경
        ctx.fillStyle = '#121416';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 그리드(희미하게)
        ctx.save();
        ctx.globalAlpha = 0.2;
        ctx.strokeStyle = '#6c757d';
        for (let x = 0; x <= COLS; x++) {
            ctx.beginPath();
            ctx.moveTo(x * CELL, 0);
            ctx.lineTo(x * CELL, ROWS * CELL);
            ctx.stroke();
        }
        for (let y = 0; y <= ROWS; y++) {
            ctx.beginPath();
            ctx.moveTo(0, y * CELL);
            ctx.lineTo(COLS * CELL, y * CELL);
            ctx.stroke();
        }
        ctx.restore();

        // 먹이
        drawCell(food.x, food.y, '#dc3545');

        // 지렁이 (머리/몸 색상 구분)
        snake.forEach((seg, i) => {
            drawCell(seg.x, seg.y, i === 0 ? '#0dcaf0' : '#20c997');
        });
    }

    function drawCell(cx, cy, color) {
        ctx.fillStyle = color;
        ctx.fillRect(cx * CELL + 2, cy * CELL + 2, CELL - 4, CELL - 4);
    }

    function drawOverlay(text, color = '#ffffff') {
        ctx.save();
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = color;
        ctx.font = 'bold 36px system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, canvas.width / 2, canvas.height / 2);
        ctx.restore();
    }

    // ====== 입력 ======
    window.addEventListener('keydown', (e) => {
        e.preventDefault();
        switch (e.key) {
            case 'ArrowUp':    if (dir.y !== 1)  nextDir = { x: 0, y: -1 }; break;
            case 'ArrowDown':  if (dir.y !== -1) nextDir = { x: 0, y: 1 };  break;
            case 'ArrowLeft':  if (dir.x !== 1)  nextDir = { x: -1, y: 0 }; break;
            case 'ArrowRight': if (dir.x !== -1) nextDir = { x: 1, y: 0 };  break;
            case ' ':
                e.preventDefault();
                running ? stopLoop() : startLoop();
                break;
            case 'r':
            case 'R':
                resetGame();
                break;
        }
    });

    btnStart.addEventListener('click', () => (running ? stopLoop() : startLoop()));
    btnReset.addEventListener('click', resetGame);
    speedSel.addEventListener('change', () => {
        interval = parseInt(speedSel.value, 10);
        if (running) startLoop(); // 즉시 반영
    });

    // ====== 시작 ======
    initGame();
    startLoop();
    canvas.focus();
</script>

<!-- Bootstrap JS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>